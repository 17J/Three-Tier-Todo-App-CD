---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins
  namespace: threetierapp
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: jenkins-role
  namespace: threetierapp
rules:
  # Core API resources
  - apiGroups: [""]
    resources:
      - secrets
      - configmaps
      - persistentvolumeclaims
      - services
      - pods
      - pods/log
      - pods/exec
      - pods/portforward
      - events
      - endpoints
      - replicationcontrollers # ADDED THIS
      - resourcequotas
      - limitranges
      - serviceaccounts
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # Apps API group
  - apiGroups: ["apps"]
    resources:
      - deployments
      - deployments/scale
      - deployments/status
      - replicasets
      - replicasets/scale
      - replicasets/status
      - statefulsets
      - statefulsets/scale
      - statefulsets/status
      - daemonsets
      - daemonsets/status
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # Networking API group
  - apiGroups: ["networking.k8s.io"]
    resources:
      - ingresses
      - ingresses/status
      - networkpolicies
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # Autoscaling
  - apiGroups: ["autoscaling"]
    resources:
      - horizontalpodautoscalers
      - horizontalpodautoscalers/status
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # Batch jobs
  - apiGroups: ["batch"]
    resources:
      - jobs
      - jobs/status
      - cronjobs
      - cronjobs/status
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # Extensions (for backward compatibility)
  - apiGroups: ["extensions"]
    resources:
      - deployments
      - replicasets
      - ingresses
      - daemonsets
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # Policy
  - apiGroups: ["policy"]
    resources:
      - poddisruptionbudgets
    verbs: ["get", "list", "watch", "create", "update", "delete", "patch"]

  # RBAC (if Jenkins needs to manage service accounts)
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources:
      - roles
      - rolebindings
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: jenkins-rolebinding
  namespace: threetierapp
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: jenkins-role
subjects:
  - kind: ServiceAccount
    name: jenkins
    namespace: threetierapp
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jenkins-cluster-role
rules:
  # Namespaces
  - apiGroups: [""]
    resources:
      - namespaces
    verbs: ["get", "list", "watch"]

  # Nodes
  - apiGroups: [""]
    resources:
      - nodes
    verbs: ["get", "list", "watch"]

  # PersistentVolumes
  - apiGroups: [""]
    resources:
      - persistentvolumes
    verbs: ["get", "list", "watch"]

  # StorageClasses
  - apiGroups: ["storage.k8s.io"]
    resources:
      - storageclasses
    verbs: ["get", "list", "watch"]

  # ComponentStatuses (for cluster health checks)
  - apiGroups: [""]
    resources:
      - componentstatuses
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jenkins-cluster-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jenkins-cluster-role
subjects:
  - kind: ServiceAccount
    name: jenkins
    namespace: threetierapp
